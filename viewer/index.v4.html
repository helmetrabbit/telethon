<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telethon Profile Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="data.js?v=4"></script>
    <style>
        .tag { display: inline-block; padding: 1px 6px; border-radius: 4px; font-size: 11px; margin-right: 3px; margin-bottom: 3px; border: 1px solid; font-weight: 500; }
        .kv { font-size: 12px; color: #475569; }
        .kv strong { color: #94a3b8; font-weight: 500; }
        details summary { cursor: pointer; list-style: none; }
        details summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">

    <div class="max-w-6xl mx-auto px-4 py-6">
        <!-- Header -->
        <div class="flex justify-between items-end mb-5">
            <div>
                <h1 class="text-2xl font-bold text-slate-900">Telethon Profiles</h1>
                <div class="text-xs text-slate-400 mt-0.5" id="stats-header">Loading...</div>
            </div>
            <div class="flex gap-2 items-center flex-wrap">
                <select id="sort-select" onchange="render()" class="text-xs border border-slate-300 rounded px-2 py-1.5 bg-white">
                    <option value="msgs">Sort: Most Messages</option>
                    <option value="reactions">Sort: Most Reactions</option>
                    <option value="engagement">Sort: Engagement Rate</option>
                    <option value="recent">Sort: Recently Active</option>
                    <option value="scam">Sort: Scam Risk</option>
                    <option value="name">Sort: Name A-Z</option>
                </select>
                <select id="group-filter" onchange="render()" class="text-xs border border-slate-300 rounded px-2 py-1.5 bg-white">
                    <option value="">All Groups</option>
                </select>
                <select id="archetype-filter" onchange="render()" class="text-xs border border-slate-300 rounded px-2 py-1.5 bg-white">
                    <option value="">All Archetypes</option>
                </select>
            </div>
        </div>

        <!-- Search -->
        <div class="mb-5">
            <input type="text" id="search" placeholder="Search name, bio, role, company, skills, tags..." 
                   class="w-full text-sm px-4 py-2.5 rounded border border-slate-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none"
                   onkeyup="render()">
        </div>

        <div class="text-xs text-slate-400 mb-3" id="stats-count"></div>

        <!-- Feed -->
        <div id="feed" class="space-y-3"></div>
    </div>

    <script>
        const data = window.TELETHON_DATA;
        const users = new Map();

        function getUser(id, name, bio) {
            if (!users.has(id)) {
                users.set(id, { id, display_name: name, bio, claims: [], psycho: null });
            }
            return users.get(id);
        }

        function esc(s) {
            if (!s) return '';
            return String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (!data) return;

            data.claims.forEach(c => {
                const u = getUser(c.subject_user_id, c.display_name, c.bio);
                u.claims.push(c);
            });

            if (data.psychographics) {
                data.psychographics.forEach(p => {
                    if (!users.has(p.user_id)) getUser(p.user_id, null, null);
                    const u = users.get(p.user_id);
                    if (u) u.psycho = p;
                });
            }

            // Populate filter dropdowns
            const allGroups = new Set();
            const allArchetypes = new Set();
            users.forEach(u => {
                if (u.psycho && u.psycho.group_tags) u.psycho.group_tags.forEach(g => allGroups.add(g));
                if (u.psycho && u.psycho.commercial_archetype) allArchetypes.add(u.psycho.commercial_archetype);
            });
            const groupSelect = document.getElementById('group-filter');
            [...allGroups].sort().forEach(g => {
                const opt = document.createElement('option');
                opt.value = g; opt.textContent = g;
                groupSelect.appendChild(opt);
            });
            const archSelect = document.getElementById('archetype-filter');
            [...allArchetypes].sort().forEach(a => {
                const opt = document.createElement('option');
                opt.value = a; opt.textContent = a.replace(/_/g, ' ');
                archSelect.appendChild(opt);
            });

            document.getElementById('stats-header').innerText =
                users.size + ' profiles \u2022 ' + data.stats.psycho_count + ' enriched \u2022 Generated ' + data.stats.generated_at.split('T')[0];

            render();
        });

        function render() {
            const feed = document.getElementById('feed');
            feed.innerHTML = '';
            const search = document.getElementById('search').value.toLowerCase();
            const sortBy = document.getElementById('sort-select').value;
            const groupFilter = document.getElementById('group-filter').value;
            const archFilter = document.getElementById('archetype-filter').value;

            let list = Array.from(users.values()).filter(u => u.psycho);

            if (search) {
                list = list.filter(u => {
                    const p = u.psycho || {};
                    const haystack = [
                        u.display_name, u.bio,
                        p.generated_bio_professional, p.generated_bio_personal,
                        p.primary_role, p.primary_company,
                        p.based_in, p.commercial_archetype,
                    ].concat(p.deep_skills || []).concat(p.fingerprint_tags || [])
                     .concat(p.tribe_affiliations || []).concat(p.group_tags || [])
                     .concat((p.notable_topics || []).map(function(t) { return typeof t === 'string' ? t : t.value; }))
                     .filter(Boolean).join(' ').toLowerCase();
                    return haystack.includes(search);
                });
            }
            if (groupFilter) list = list.filter(u => u.psycho && u.psycho.group_tags && u.psycho.group_tags.indexOf(groupFilter) !== -1);
            if (archFilter) list = list.filter(u => u.psycho && u.psycho.commercial_archetype === archFilter);

            list.sort(function(a, b) {
                var pa = a.psycho || {}, pb = b.psycho || {};
                switch (sortBy) {
                    case 'msgs': return (pb.total_messages || 0) - (pa.total_messages || 0);
                    case 'reactions': return (pb.total_reactions || 0) - (pa.total_reactions || 0);
                    case 'engagement': return (Number(pb.engagement_rate) || 0) - (Number(pa.engagement_rate) || 0);
                    case 'recent': return (pa.last_active_days == null ? 9999 : pa.last_active_days) - (pb.last_active_days == null ? 9999 : pb.last_active_days);
                    case 'scam': return (pb.scam_risk_score || 0) - (pa.scam_risk_score || 0);
                    case 'name': return (a.display_name || '').localeCompare(b.display_name || '');
                    default: return 0;
                }
            });

            document.getElementById('stats-count').innerText = 'Showing ' + list.length + ' profiles';

            var max = Math.min(list.length, 200);
            for (var idx = 0; idx < max; idx++) {
                var u = list[idx];
                var p = u.psycho;
                var card = document.createElement('div');
                var scamBorder = (p.scam_risk_score || 0) >= 60 ? 'border-l-red-500' :
                                 (p.scam_risk_score || 0) >= 30 ? 'border-l-yellow-400' : 'border-l-emerald-400';
                card.className = 'bg-white rounded-lg shadow-sm border border-slate-200 border-l-4 ' + scamBorder + ' overflow-hidden';

                var partnersHtml = '';
                if (p.top_conversation_partners && p.top_conversation_partners.length > 0) {
                    var pList = p.top_conversation_partners.map(function(pr) {
                        return '<span class="text-xs">' + esc(pr.display_name) + ' <span class="text-slate-400">(' + pr.replies_sent + '\u2191 ' + pr.replies_received + '\u2193)</span></span>';
                    }).join(' \u00b7 ');
                    partnersHtml = '<div class="kv mt-1"><strong>Conversation partners:</strong> ' + pList + '</div>';
                }

                var socialsHtml = '';
                if (p.social_urls && p.social_urls.length > 0) {
                    var links = p.social_urls.map(function(url) {
                        var href = url.indexOf('http') === 0 ? url : 'https://' + url;
                        return '<a href="' + esc(href) + '" target="_blank" class="text-blue-600 hover:underline text-xs">' + esc(url) + '</a>';
                    }).join(', ');
                    socialsHtml = '<div class="kv"><strong>Links:</strong> ' + links + '</div>';
                }

                function renderEvList(items) {
                    if (!items || items.length === 0) return '';
                    return items.map(function(item) {
                        if (typeof item === 'string') return esc(item);
                        var val = esc(item.value);
                        var quote = item.quote ? esc(item.quote) : '';
                        var date = item.date ? esc(item.date) : '';
                        var title = '';
                        if (quote) title += '"' + quote + '"';
                        if (date) title += ' (' + date + ')';
                        return title ? '<span class="underline decoration-dotted cursor-help" title="' + esc(title) + '">' + val + '</span>' : val;
                    }).join(', ');
                }

                function pills(items, bg, text) {
                    if (!items || items.length === 0) return '';
                    return items.map(function(i) { return '<span class="tag ' + bg + ' ' + text + '">' + esc(i) + '</span>'; }).join('');
                }

                // Traits
                var traits = [p.tone, p.professionalism, p.verbosity, p.decision_style, p.seniority_signal].filter(Boolean);
                var traitsHtml = traits.map(function(t) { return '<span class="tag bg-slate-100 text-slate-600 border-slate-200">' + esc(t) + '</span>'; }).join('');
                if (p.approachability != null) traitsHtml += '<span class="tag bg-emerald-50 text-emerald-700 border-emerald-200">' + (p.approachability * 10).toFixed(0) + '/10 open</span>';

                // Stats line
                var stats = [];
                if (p.total_messages) stats.push('<strong>' + p.total_messages + '</strong> msgs');
                if (p.total_reactions) stats.push('<strong>' + p.total_reactions + '</strong> reactions');
                if (p.total_replies_received) stats.push('<strong>' + p.total_replies_received + '</strong> replies');
                if (p.engagement_rate) stats.push('<strong>' + Number(p.engagement_rate).toFixed(1) + '%</strong> engagement');
                if (p.avg_msg_length) stats.push('avg <strong>' + p.avg_msg_length + '</strong> chars');
                if (p.buying_power) stats.push(esc(p.buying_power));
                if ((p.scam_risk_score || 0) >= 30) stats.push('<span class="text-red-600 font-bold">Scam: ' + p.scam_risk_score + '/100</span>');
                var statsHtml = stats.join(' &middot; ');

                card.innerHTML = 
                    '<div class="p-4">' +
                        '<div class="flex justify-between items-start mb-2">' +
                            '<div class="flex-1 min-w-0">' +
                                '<div class="flex items-center gap-2 flex-wrap">' +
                                    '<h3 class="text-base font-bold text-slate-900 truncate">' + esc(u.display_name || 'Unknown') + '</h3>' +
                                    (p.primary_role ? '<span class="text-xs text-slate-500">' + esc(p.primary_role) + '</span>' : '') +
                                    (p.primary_company ? '<span class="text-xs text-slate-400">@ ' + esc(p.primary_company) + '</span>' : '') +
                                    (p.commercial_archetype ? '<span class="tag bg-indigo-100 text-indigo-700 border-indigo-200">' + esc(p.commercial_archetype.replace(/_/g, ' ')) + '</span>' : '') +
                                    (p.career_stage ? '<span class="text-[10px] text-slate-400">' + esc(p.career_stage) + '</span>' : '') +
                                '</div>' +
                                (p.generated_bio_professional ? '<p class="text-xs text-slate-600 mt-1">' + esc(p.generated_bio_professional) + '</p>' : '') +
                            '</div>' +
                            '<div class="flex flex-col items-end ml-3 shrink-0 text-right">' +
                                '<div class="text-xs font-mono text-slate-400">#' + u.id + '</div>' +
                                (p.last_active_days != null ? '<div class="text-[10px] ' + (p.last_active_days < 30 ? 'text-emerald-600' : p.last_active_days < 180 ? 'text-slate-500' : 'text-slate-300') + '">' + p.last_active_days + 'd ago</div>' : '') +
                                (p.confidence_score ? '<div class="text-[10px] text-slate-400">' + (p.confidence_score * 100).toFixed(0) + '% conf</div>' : '') +
                            '</div>' +
                        '</div>' +

                        '<div class="flex gap-4 text-[11px] text-slate-500 mb-2 border-b border-slate-100 pb-2 flex-wrap">' + statsHtml + '</div>' +

                        '<div class="mb-2 flex flex-wrap gap-1">' + traitsHtml + '</div>' +

                        '<div class="space-y-0.5">' +
                            (p.based_in ? '<div class="kv"><strong>Based in:</strong> ' + esc(p.based_in) + '</div>' : '') +
                            (p.languages && p.languages.length > 0 ? '<div class="kv"><strong>Languages:</strong> ' + p.languages.map(esc).join(', ') + '</div>' : '') +
                            (p.deep_skills && p.deep_skills.length > 0 ? '<div class="kv"><strong>Skills:</strong> ' + p.deep_skills.map(esc).join(', ') + '</div>' : '') +
                            (p.fifo ? '<div class="kv"><strong>Active:</strong> ' + esc(p.fifo) + '</div>' : '') +
                            (p.peak_hours && p.peak_hours.length > 0 ? '<div class="kv"><strong>Peak hours:</strong> ' + p.peak_hours.map(esc).join(', ') + ' UTC</div>' : '') +
                            (p.most_active_days && p.most_active_days.length > 0 ? '<div class="kv"><strong>Most active:</strong> ' + p.most_active_days.map(esc).join(', ') + '</div>' : '') +
                            socialsHtml +
                            partnersHtml +
                        '</div>' +

                        (p.group_tags && p.group_tags.length > 0 ? '<div class="mt-2">' + pills(p.group_tags, 'bg-violet-50', 'text-violet-700 border-violet-200') + '</div>' : '') +

                        '<details class="mt-2">' +
                            '<summary class="text-xs text-blue-600 font-medium hover:text-blue-800">Show details</summary>' +
                            '<div class="mt-2 space-y-1.5 border-t border-slate-100 pt-2">' +
                                (p.generated_bio_personal ? '<div class="kv"><strong>Personal bio:</strong> <em>' + esc(p.generated_bio_personal) + '</em></div>' : '') +
                                (p.preferred_contact_style ? '<div class="kv"><strong>Contact style:</strong> ' + esc(p.preferred_contact_style) + '</div>' : '') +
                                (p.notable_topics && p.notable_topics.length > 0 ? '<div class="kv"><strong>Topics:</strong> ' + renderEvList(p.notable_topics) + '</div>' : '') +
                                (p.pain_points && p.pain_points.length > 0 ? '<div class="kv"><strong>Pain points:</strong> ' + renderEvList(p.pain_points) + '</div>' : '') +
                                (p.crypto_values && p.crypto_values.length > 0 ? '<div class="kv"><strong>Values:</strong> ' + renderEvList(p.crypto_values) + '</div>' : '') +
                                (p.connection_requests && p.connection_requests.length > 0 ? '<div class="kv"><strong>Seeking:</strong> ' + renderEvList(p.connection_requests) + '</div>' : '') +
                                (p.quirks && p.quirks.length > 0 ? '<div class="kv"><strong>Quirks:</strong> ' + renderEvList(p.quirks) + '</div>' : '') +
                                (p.driving_values && p.driving_values.length > 0 ? '<div class="kv"><strong>Driving values:</strong> ' + p.driving_values.map(esc).join(', ') + '</div>' : '') +
                                (p.technical_specifics && p.technical_specifics.length > 0 ? '<div class="kv"><strong>Tech:</strong> ' + p.technical_specifics.map(esc).join(', ') + '</div>' : '') +
                                (p.business_focus && p.business_focus.length > 0 ? '<div class="kv"><strong>Biz focus:</strong> ' + p.business_focus.map(esc).join(', ') + '</div>' : '') +
                                (p.tribe_affiliations && p.tribe_affiliations.length > 0 ? '<div class="kv"><strong>Tribes:</strong> ' + p.tribe_affiliations.map(esc).join(', ') + '</div>' : '') +
                                (p.attended_events && p.attended_events.length > 0 ? '<div class="kv"><strong>Events:</strong> ' + p.attended_events.map(esc).join(', ') + '</div>' : '') +
                                (p.affiliations && p.affiliations.length > 0 ? '<div class="kv"><strong>Affiliations:</strong> ' + p.affiliations.map(esc).join(', ') + '</div>' : '') +
                                (p.social_platforms && p.social_platforms.length > 0 ? '<div class="kv"><strong>Platforms:</strong> ' + p.social_platforms.map(esc).join(', ') + '</div>' : '') +
                                (p.reasoning ? '<div class="kv mt-1 text-slate-400 italic border-l-2 border-slate-200 pl-2">' + esc(p.reasoning) + '</div>' : '') +
                                (p.fingerprint_tags && p.fingerprint_tags.length > 0 ? '<div class="mt-1.5">' + pills(p.fingerprint_tags, 'bg-slate-100', 'text-slate-500 border-slate-200') + '</div>' : '') +
                            '</div>' +
                        '</details>' +
                    '</div>';
                feed.appendChild(card);
            }

            if (list.length === 0) {
                feed.innerHTML = '<div class="text-center text-slate-400 py-10">No profiles match your filters.</div>';
            }
            if (list.length > 200) {
                var note = document.createElement('div');
                note.className = 'text-center text-xs text-slate-400 py-4';
                note.textContent = 'Showing 200 of ' + list.length + '. Narrow your search to see more.';
                feed.appendChild(note);
            }
        }
    </script>
</body>
</html>
